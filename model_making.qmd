---
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r}
library(tidyverse)
library(lubridate)
library(recipes)
library(themis)
library(vip)
library(rpart)
library(recipes)
library(parsnip)
library(glmnet)
library(ranger)
library(kknn)
library(rsample)
library(tidy)
```

#model making
```{r}
data <- read.csv("final_lead_data_weather.csv")

data$weekday <- wday(data$date, label = TRUE)
data$month <- month(data$date, label = TRUE)
data$yearday <- yday(data$date)

bike_modeling <- data |>
  slice(1:1379)

bike_implementation <- data |>
  slice(1380:1409) |>
  select(-ridership)

set.seed(20211101)

data_split <- initial_split(bike_modeling)
data_train <- training(data_split)
data_test <- testing(data_split)

data_folds <- vfold_cv(data = data_train, v = 10, repeats = 5)
```

```{r}
#Recipe
bike_rec <- data_train |>
  recipe(ridership ~ .) |>
   step_zv(all_predictors()) |>
   step_nzv(all_predictors()) 

 

```

```{r}

#Linear Model
#Can we hyperparamterize this?

lm <- linear_reg() |>
  set_mode(mode = "regression") |>
  set_engine(engine = "lm")

lm_wf <- workflow() |>
  add_model(lm) |>
  add_recipe(bike_rec)

lm_res <- lm_wf |>
  fit_resamples(resamples = data_folds, rankdeficients = "NA")

lm_metrics <- lm_res |>
  collect_metrics(summarize = FALSE) |>
  filter(.metric == "rmse")
```

```{r}
#KNN
knn <-
  nearest_neighbor(neighbors = tune()) |>
  set_engine(engine = "kknn") |>
  set_mode(mode = "regression")

knn_grid <- grid_regular(neighbors(range = c(1, 99)), levels = 10)

knn_wf <- workflow() |>
  add_recipe(bike_rec) |>
  add_model(knn)

knn_res <- knn_wf |>
  tune_grid(
    resamples = data_folds,
    grid = knn_grid,
    metrics = metric_set(rmse)
  )

knn_wf_final <- knn_wf |> 
  finalize_workflow(select_best(knn_res))

knn_res_final <- knn_wf_final |>
  tune_grid(
    resamples = data_folds,
    grid = knn_grid,
    metrics = metric_set(rmse)
  )

knn_metrics_final <- knn_res_final |>
  collect_metrics(summarize = FALSE) |>
  filter(.metric == "rmse")

```

```{r}
rf <- rand_forest(
  mtry = tune(),
  min_n = tune(),
  trees = 300
) |>
  set_mode("regression") |>
  set_engine("ranger",
             importance = "impurity")

rf_wf <- workflow() |>
  add_model(rf) |>
  add_recipe(bike_rec)

rf_grid <- grid_regular(
  mtry(range = c(1, 5)),
  min_n(range = c(1, 5)),
  levels = 3
)

rf_resample <- tune_grid(
  rf_wf, 
  resamples = data_folds,
  grid = rf_grid,
  metrics = metric_set(rmse)
)

```

```{r}
#Ridge

 ridge_mod <- linear_reg(penalty = 1, mixture = 0) |>
    set_mode(mode = "regression") |>
    set_engine(engine = "glmnet")  
  
  ridge_wf <- workflow() |>
    add_recipe(recipe = bike_rec) |>
    add_model(spec = ridge_mod)

  ridge_resamples <- fit_resamples(ridge_wf, resamples = cv_folds)
  
  ridge_rmse <- collect_metrics(ridge_resamples) |>
  filter(.metric == "rmse")

```
